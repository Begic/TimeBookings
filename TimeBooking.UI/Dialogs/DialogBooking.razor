@inject ITimeBookingProvider TimeBookingProvider
@inject ITimeBookingDetailProvider TimeBookingDetailProvider
@inject IDialogService DialogService
@inject ISnackbar Toaster

<EditForm Model="@editModel" OnValidSubmit="@AddTimeBooking">
    <FluentValidationValidator/>
    <MudDialog>
        <TitleContent>
            @if (TimeBookingDay == null)
            {
                <MudText>Zeitbuchung hinzufügen</MudText>
            }
            else
            {
                <MudText>Zeitbuchung bearbeiten</MudText>
            }
        </TitleContent>
        <DialogContent>
            <MudGrid Class="mb-6">
                <MudItem md="3">
                    <MudDatePicker Disabled="@true" Label="Tag" @bind-Date="@editModel.BookingDay"/>
                </MudItem>
                <MudItem md="12">
                    <MudTextField Label="Kommentar" @bind-Value="@editModel.Remark" For="@(() => editModel.Remark)" Lines="3"></MudTextField>
                </MudItem>

                @if (TimeBookingDay != null)
                {
                    <MudItem md="12">
                        <DefaultLayout>
                            <Actions>
                            
                                <MudTooltip Text="Einstempeln">
                                    <MudFab Class="me-2" Size="@Size.Small" IconSize="@Size.Small" Color="@Color.Success" StartIcon="@Icons.Material.Filled.AddCircle" OnClick="@OnClickStampIn">Einstempeln</MudFab>
                                </MudTooltip>
                                
                                <MudTooltip Text="Ausstempeln">
                                    <MudFab Size="@Size.Small" IconSize="@Size.Small" Color="@Color.Info"  StartIcon="@Icons.Material.Filled.Square" OnClick="@OnClickStampOut">Ausstempeln</MudFab>
                                </MudTooltip>
                            </Actions>
                            <Content>
                                <MudDataGrid Items="@editModel.TimeBookingDetails"
                                             RowsPerPage="10"
                                             Dense="@true"
                                             Striped="@true"
                                             Hover="@true"
                                             Virtualize="@true">
                                    <Columns>
                                        <PropertyColumn Title="Start" Property="@(x => x.StartTime)" Format="d"/>
                                        <PropertyColumn Title="Ende" Property="@(x => x.EndTime)"/>
                                        <PropertyColumn Title="Kommentar" Property="@(x => x.Remark)"/>
                                        <TemplateColumn >
                                            <CellTemplate Context="edit">
                                                <MudStack Row>
                                                    <MudTooltip Text="Bearbeiten">
                                                        <MudFab Size="@Size.Small" IconSize="@Size.Small" Color="@Color.Warning" StartIcon="@Icons.Material.Filled.Edit" OnClick="() => OnClickEdit(edit.Item)"/>
                                                    </MudTooltip>
                                                    <MudTooltip Text="Löschen">
                                                        <MudFab Size="@Size.Small" IconSize="@Size.Small" Color="@Color.Error" StartIcon="@Icons.Material.Filled.Delete" OnClick="() => OnDelete(edit.Item)"/>
                                                    </MudTooltip>
                                                </MudStack>
                                            </CellTemplate>
                                        </TemplateColumn>
                                    </Columns>
                                </MudDataGrid>
                            </Content>
                        </DefaultLayout>
                    </MudItem>
                }
            </MudGrid>

        </DialogContent>
        <DialogActions>
            <MudButton Color="@Color.Success" Variant="@Variant.Filled" ButtonType="@ButtonType.Submit" EndIcon="@Icons.Material.Filled.AddCircle">Hinzufügen</MudButton>
            <MudButton Color="@Color.Info" Variant="@Variant.Filled" ButtonType="@ButtonType.Button" EndIcon="@Icons.Material.Filled.Cancel" OnClick="@OnClickCancel">Abbrechen</MudButton>
        </DialogActions>
    </MudDialog>
</EditForm>

@code
{
    [Parameter] public UserInfo CurrentUser { get; set; }
    [Parameter] public TimeBookingDayInfo? TimeBookingDay { get; set; }

    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    private EditTimeBookingDay editModel = new();

    protected override async Task OnInitializedAsync()
    {
        if (TimeBookingDay != null)
        {
            editModel = new EditTimeBookingDay()
            {
                Id = TimeBookingDay.Id,
                BookingDay = TimeBookingDay.BookingDay,
                Remark = TimeBookingDay.Remark,
                TimeBookingDetails = TimeBookingDay.TimeBookingDetails.Select(x => new EditTimeBookingDetail()
                {
                    Id = x.Id,
                    StartTime = x.StartTime,
                    EndTime = x.EndTime,
                    Remark = x.Remark
                }).ToList()
            };
        }
        else
        {
            editModel = new EditTimeBookingDay
            {
                BookingDay = DateTime.Today,
            };
        }

        await Refresh();
    }

    private async Task Refresh()
    {
        
    }

    private async Task AddTimeBooking()
    {
        await TimeBookingProvider.AddTimeBookingDay(CurrentUser, editModel);
        Toaster.Add("Erfolgreich hinzugefügt", Severity.Success);
        MudDialog.Close(true);
    }

    private async Task OnClickCancel()
    {
        Toaster.Add("Erfolgreich abgebrochen", Severity.Info);
        MudDialog.Close();
    }

    private async Task OnClickEdit(EditTimeBookingDetail? info)
    {
        
    }

    private async Task OnDelete(EditTimeBookingDetail? item)
    {
        var result = await DialogService.ShowAsync<DialogDelete>("Achtung!", new DialogParameters(), new DialogOptions
        {
            CloseOnEscapeKey = false,
            DisableBackdropClick = true
        });

        if ((bool)(await result.Result).Data)
        {
            await TimeBookingDetailProvider.DeleteTimeStamping(item.Id);
            Toaster.Add("Erfolgreich gelöscht", Severity.Success);
            await Refresh();
        }
    }

    private async Task OnClickStampIn()
    {
        await TimeBookingDetailProvider.StampIn(CurrentUser, editModel.Id);
        Toaster.Add("Erfolgreich eingestempelt", Severity.Success);
        await Refresh();
    }
    
    private async Task OnClickStampOut()
    {
        await TimeBookingDetailProvider.StampOut(CurrentUser, editModel.Id);
        Toaster.Add("Erfolgreich ausgestempelt", Severity.Success);
        await Refresh();
    }
}